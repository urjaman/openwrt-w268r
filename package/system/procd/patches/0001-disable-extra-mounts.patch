From 150897226d20db3dd8a36eb1302be80f1d4b4f24 Mon Sep 17 00:00:00 2001
From: Urja Rannikko <urjaman@gmail.com>
Date: Tue, 3 Nov 2015 18:18:27 +0200
Subject: [PATCH] disable extra mounts

---
 initd/early.c   | 11 +----------
 plug/coldplug.c |  4 +---
 2 files changed, 2 insertions(+), 13 deletions(-)

diff --git a/initd/early.c b/initd/early.c
index e87774f..327d5e4 100644
--- a/initd/early.c
+++ b/initd/early.c
@@ -66,21 +66,12 @@ early_mounts(void)
 	mount("proc", "/proc", "proc", MS_NOATIME | MS_NODEV | MS_NOEXEC | MS_NOSUID, 0);
 	mount("sysfs", "/sys", "sysfs", MS_NOATIME | MS_NODEV | MS_NOEXEC | MS_NOSUID, 0);
 	mount("cgroup", "/sys/fs/cgroup", "cgroup",  MS_NODEV | MS_NOEXEC | MS_NOSUID, 0);
-	mount("tmpfs", "/dev", "tmpfs", MS_NOATIME | MS_NOSUID, "mode=0755,size=512K");
-	ignore(symlink("/tmp/shm", "/dev/shm"));
+ 	mkdir("/dev/shm", 01777);
 	mkdir("/dev/pts", 0755);
 	mount("devpts", "/dev/pts", "devpts", MS_NOATIME | MS_NOEXEC | MS_NOSUID, "mode=600");
 	early_dev();
 
 	early_console("/dev/console");
-	if (mount_zram_on_tmp()) {
-		mount("tmpfs", "/tmp", "tmpfs", MS_NOSUID | MS_NODEV | MS_NOATIME, 0);
-		mkdir("/tmp/shm", 01777);
-	} else {
-		mkdir("/tmp/shm", 01777);
-		mount("tmpfs", "/tmp/shm", "tmpfs", MS_NOSUID | MS_NODEV | MS_NOATIME,
-				"mode=01777");
-	}
 	mkdir("/tmp/run", 0777);
 	mkdir("/tmp/lock", 0777);
 	mkdir("/tmp/state", 0777);
diff --git a/plug/coldplug.c b/plug/coldplug.c
index 5fcb9a3..c40ee09 100644
--- a/plug/coldplug.c
+++ b/plug/coldplug.c
@@ -44,9 +44,7 @@ void procd_coldplug(void)
 	unsigned int oldumask = umask(0);
 
 	umount2("/dev/pts", MNT_DETACH);
-	umount2("/dev/", MNT_DETACH);
-	mount("tmpfs", "/dev", "tmpfs", MS_NOSUID, "mode=0755,size=512K");
-	ignore(symlink("/tmp/shm", "/dev/shm"));
+ 	mkdir("/dev/shm", 01777);
 	mkdir("/dev/pts", 0755);
 	umask(oldumask);
 	mount("devpts", "/dev/pts", "devpts", MS_NOEXEC | MS_NOSUID, 0);
-- 
2.6.1

